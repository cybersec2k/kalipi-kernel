1a2
> . rpi2-KaliPI.config
4a6
> # Modded by CyberSec2k @8/2015
11a14,21
> # Make sure that the cross compiler can be found in the path before we do
> # anything else, that way the builds don't fail half way through.
> if [ $(compgen -c $CROSS_COMPILE | wc -l) -eq 0 ] ; then
>     echo "Missing cross compiler."
>     exit 1
> fi
> 
> rm -rf rpi2-${kalipirelease}
42c52,54
< #export http_proxy="http://localhost:3142/"
---
> if [ "${useaptcacher}" == "YES" ]; then
> export http_proxy="http://localhost:3142/"
> fi
59c71
< echo "kali" > kali-$architecture/etc/hostname
---
> echo "KaliPI" > kali-$architecture/etc/hostname
61d72
< # So X doesn't complain, we add kali to hosts
63c74
< 127.0.0.1       kali    localhost
---
> 127.0.0.1       KaliPI    localhost
169a181,182
> # Wait for loop0p1
> sleep 5 ; sync
192,217d204
< # Uncomment this if you use apt-cacher-ng otherwise git clones will fail.
< #unset http_proxy
< 
< # Kernel section. If you want to use a custom kernel, or configuration, replace
< # them in this section.
< git clone --depth 1 https://github.com/raspberrypi/linux -b rpi-3.18.y ${basedir}/root/usr/src/kernel
< 
< cd ${basedir}/root/usr/src/kernel
< git rev-parse HEAD > ../kernel-at-commit
< patch -p1 --no-backup-if-mismatch < ${basedir}/../patches/kali-wifi-injection-3.18.patch
< touch .scmversion
< export ARCH=arm
< export CROSS_COMPILE=arm-linux-gnueabihf-
< cp ${basedir}/../kernel-configs/rpi2-3.18.config .config
< cp ${basedir}/../kernel-configs/rpi2-3.18.config ../rpi2-3.18.config
< make -j $(grep -c processor /proc/cpuinfo)
< make modules_install INSTALL_MOD_PATH=${basedir}/root
< git clone --depth 1 https://github.com/raspberrypi/firmware.git rpi-firmware
< cp -rf rpi-firmware/boot/* ${basedir}/bootp/
< cp arch/arm/boot/zImage ${basedir}/bootp/kernel7.img
< cp arch/arm/boot/dts/bcm*.dtb ${basedir}/bootp/
< make mrproper
< cp ../rpi2-3.18.config .config
< make modules_prepare
< cd ${basedir}
< 
222a210,214
> # Create config.txt file
> cat << EOF > ${basedir}/bootp/config.txt
> gpu_mem=16
> EOF
> 
233a226,249
> # Uncomment this if you use apt-cacher-ng otherwise git clones will fail.
> if [ "${useaptcacher}" == "YES" ]; then
> unset http_proxy
> fi
> 
> # Kernel section. If you want to use a custom kernel, or configuration, replace them in this section.
> cd ${basedir}/root/usr/src/kernel
> git clone --depth 1 https://github.com/raspberrypi/linux -b rpi-3.18.y ${basedir}/root/usr/src/kernel
> git rev-parse HEAD > kernel-at-commit
> patch -p1 --no-backup-if-mismatch < ${basedir}/../../kali-arm-build-scripts/patches/kali-wifi-injection-3.18.patch
> touch .scmversion
> make clean
> cp ${basedir}/../kernel-configs/${kernelconf} .config
> cp ${basedir}/../kernel-configs/${kernelconf} ../${kernelconf}
> make ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE -j $(grep -c processor /proc/cpuinfo)
> make ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE modules_install INSTALL_MOD_PATH=${basedir}/root
> git clone --depth 1 https://github.com/raspberrypi/firmware.git rpi-firmware
> cp -rf rpi-firmware/boot/* ${basedir}/bootp/
> cp arch/arm/boot/zImage ${basedir}/bootp/kernel7.img
> cp arch/arm/boot/dts/bcm*.dtb ${basedir}/bootp/
> make ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE mrproper
> cp ../${kernelconf} .config
> make ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE modules_prepare
> cd ${basedir}
238,240d253
< 
< cd ${basedir}
< 
244a258,259
> cd ${basedir}
> sync
246a262
> sync
247a264
> sync
253,254c270,271
< echo "Cleaning up the temporary build files..."
< rm -rf ${basedir}/kernel ${basedir}/bootp ${basedir}/root ${basedir}/kali-$architecture ${basedir}/boot ${basedir}/patches
---
> #echo "Cleaning up the temporary build files..."
> #rm -rf ${basedir}/kernel ${basedir}/bootp ${basedir}/root ${basedir}/kali-armhf ${basedir}/boot ${basedir}/patches
260c277,278
< sha1sum kali-$1-rpi2.img > ${basedir}/kali-$1-rpi2.img.sha1sum
---
> cd ${basedir}
> sha1sum kali-$1-rpi2.img > kali-$1-rpi2.img.sha1sum
265,266c283,284
< pixz ${basedir}/kali-$1-rpi2.img ${basedir}/kali-$1-rpi2.img.xz
< rm ${basedir}/kali-$1-rpi2.img
---
> pixz kali-$1-rpi2.img kali-$1-rpi2.img.xz
> rm kali-$1-rpi2.img
268c286
< sha1sum kali-$1-rpi2.img.xz > ${basedir}/kali-$1-rpi2.img.xz.sha1sum
---
> sha1sum kali-$1-rpi2.img.xz > kali-$1-rpi2.img.xz.sha1sum
